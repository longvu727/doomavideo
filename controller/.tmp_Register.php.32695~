<?php
    include_once( "Controller.php" );
    
    class Login extends Controller {
        private $user;
        
        public function __construct() { parent::__construct(); }
        
        public function findUser( $db, $userName ) {
            include_once($this->controllerDir . "models/Users.php");
            
            $users = new Users($db);
            $this->user = $users->findUser( $userName );
            
            return $this->user;
        }
        
        public function validateUser( $db, $userName, $password ) {
            $userRow = $this->findUser( $db, $userName );
            
            include_once($this->controllerDir . "models/Users.php");
            $users = new Users($db);
            
            $salt = $users->getSalt();
            if( md5($userRow["password"].$salt) == $password ) { 
                return 1; 
            }
            return 0;
        }
        
        public function createSession( $db, $userName="", $ip="" ) {
            include_once($this->controllerDir . "models/Sessions.php");
            
            $sessionRow;
            
            if( isset($this->user) ){
                $this->user = $this->findUser($db, $userName);
            }
            $session = new Sessions( $db );
            
            if(  $sessionRow = $session->findSessionByUserIdAndIp( $this->user['userid'], $ip )  ) {
                $session->updateSessionTime();
            }
            else {
                $sessionId = md5("$userName $ip");
                $values = array($sessionId, $this->user['userid'], $ip);
                
                $session->insert($session->columns, $values );
                $sessionRow = $session->findSessionBySessionId( $sessionId );
            }
            
            setcookie( "DOOMA_SESSION", $sessionRow['sessionid'] );
        }
    }
?>